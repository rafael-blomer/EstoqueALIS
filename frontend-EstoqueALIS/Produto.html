<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Produto</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
        }

        header {
            background-color: #333;
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
        }

        header .right-section {
            display: flex;
            align-items: center;
        }

        #btn-logout,
        #btn-voltar {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
        }

        #btn-logout {
            background-color: #f44336;
            color: white;
        }

        #btn-voltar {
            background-color: #444;
            color: white;
        }

        #btn-voltar:hover {
            background-color: #555;
        }

        #btn-logout:hover {
            background-color: #d32f2f;
        }

        main {
            margin: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-group button {
            margin: 5px;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-update {
            background-color: #4CAF50;
            color: white;
        }

        .btn-lote {
            background-color: #2196F3;
            color: white;
        }

        .btn-retirada {
            background-color: #FF9800;
            color: white;
        }

        .btn-movimentacoes {
            background-color: #9C27B0;
            color: white;
        }

        .btn-desativar {
            background-color: #f44336;
            color: white;
        }

        .action-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }

        form input,
        form textarea {
            display: block;
            margin: 8px 0;
            padding: 8px;
            width: 100%;
            max-width: 400px;
        }

        form button {
            margin-top: 10px;
            background-color: #333;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        table th,
        table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        table th {
            background: #333;
            color: white;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        ul li {
            margin-bottom: 5px;
            padding: 5px;
            background: #eee;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <header>
        <h2>Detalhes do Produto</h2>
        <div class="right-section">
            <button id="btn-voltar">⬅ Voltar</button>
            <button id="btn-logout">Sair</button>
        </div>
    </header>

    <main>
        <h3 id="nomeProduto"></h3>
        <p><b>ID:</b> <span id="idProduto"></span></p>
        <p><b>Marca:</b> <span id="marcaProduto"></span></p>
        <p><b>Descrição:</b> <span id="descricaoProduto"></span></p>
        <p><b>Quantidade Total:</b> <span id="quantidadeProduto"></span></p>
        <p><b>Estoque:</b> <span id="estoqueProduto"></span></p>

        <div class="btn-group">
            <button class="btn-update" onclick="mostrarAtualizar()">Atualizar Informações</button>
            <button class="btn-lote" onclick="mostrarLote()">Adicionar Lotes</button>
            <button class="btn-retirada" onclick="mostrarRetirada()">Retirar Unidades</button>
            <button class="btn-movimentacoes" onclick="mostrarMovimentacoes()">Ver Movimentações</button>
            <button class="btn-desativar" onclick="desativarProduto()">Desativar Produto</button>
        </div>

        <div id="actionArea"></div>
    </main>

    <script>
        const token = localStorage.getItem("token");
        if (!token) {
            alert("Você precisa estar logado!");
            window.location.href = "login.html";
        }

        const urlParams = new URLSearchParams(window.location.search);
        const produtoId = urlParams.get("id");
        let produto = null;

        function carregarProduto() {
            fetch(`http://localhost:8080/produto/${produtoId}`, {
                headers: { "Authorization": token }
            })
                .then(r => r.json())
                .then(p => {
                    produto = p;
                    document.getElementById("nomeProduto").innerText = p.nome;
                    document.getElementById("idProduto").innerText = p.id;
                    document.getElementById("marcaProduto").innerText = p.marca;
                    document.getElementById("descricaoProduto").innerText = p.descricao;
                    document.getElementById("quantidadeProduto").innerText = p.quantidadeTotal;
                    document.getElementById("estoqueProduto").innerText = p.estoque.nomeEstoque;
                });
        }

        carregarProduto();

        function renderizarMovimentacoes(movs) {
            movs.sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));

            let html = `<div class="action-section"><h4>Movimentações</h4>
    <table><thead>
      <tr><th>ID</th><th>Data/Hora</th><th>Tipo</th><th>Itens</th></tr>
    </thead><tbody>`;

            movs.forEach(m => {
                let itensHtml = "<ul>";
                m.itensMovimentacoesLote.forEach(i => {
                    itensHtml += `<li>Lote: ${i.loteFabricante} | Qtde: ${i.quantidadeMexidaLote} | Produto: ${i.nomeProduto} (${i.marcaProduto})</li>`;
                });
                itensHtml += "</ul>";
                html += `<tr>
      <td>${m.id}</td>
      <td>${new Date(m.dataHora).toLocaleString()}</td>
      <td>${m.tipoMovimentacao}</td>
      <td>${itensHtml}</td>
    </tr>`;
            });
            html += "</tbody></table></div>";
            document.getElementById("actionArea").innerHTML = html;
        }

        function mostrarAtualizar() {
            document.getElementById("actionArea").innerHTML = `
      <div class="action-section">
        <h4>Atualizar Produto</h4>
        <form id="formAtualizar">
          <input type="text" id="nome" value="${produto.nome}">
          <input type="text" id="marca" value="${produto.marca}">
          <textarea id="descricao">${produto.descricao}</textarea>
          <button type="submit">Salvar</button>
        </form>
      </div>`;
            document.getElementById("formAtualizar").onsubmit = e => {
                e.preventDefault();
                fetch(`http://localhost:8080/produto/atualizar/${produtoId}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json", "Authorization": token },
                    body: JSON.stringify({
                        nome: document.getElementById("nome").value,
                        marca: document.getElementById("marca").value,
                        descricao: document.getElementById("descricao").value
                    })
                }).then(r => {
                    if (!r.ok) throw new Error();
                    alert("Produto atualizado!");
                    carregarProduto();
                }).catch(() => alert("Erro ao atualizar produto"));
            };
        }

        function mostrarLote() {
            document.getElementById("actionArea").innerHTML = `
      <div class="action-section">
        <h4>Adicionar Lote</h4>
        <form id="formLote">
          <input type="number" id="quantidadeLote" placeholder="Quantidade" required>
          <input type="date" id="dataValidade" required>
          <input type="text" id="loteFabricante" placeholder="Lote do Fabricante" required>
          <button type="submit">Adicionar</button>
        </form>
      </div>`;
            document.getElementById("formLote").onsubmit = e => {
                e.preventDefault();
                fetch("http://localhost:8080/loteproduto", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": token },
                    body: JSON.stringify({
                        produtoId: produtoId,
                        quantidadeLote: document.getElementById("quantidadeLote").value,
                        dataValidade: document.getElementById("dataValidade").value,
                        loteFabricante: document.getElementById("loteFabricante").value
                    })
                }).then(r => {
                    if (!r.ok) throw new Error();
                    alert("Lote adicionado!");
                    carregarProduto();
                }).catch(() => alert("Erro ao adicionar lote"));
            };
        }

        function mostrarRetirada() {
            document.getElementById("actionArea").innerHTML = `
      <div class="action-section">
        <h4>Retirar Unidades</h4>
        <form id="formRetirada">
          <input type="number" id="quantidadeRetirada" placeholder="Quantidade a retirar" required>
          <button type="submit">Retirar</button>
        </form>
        <div id="resultado-retirada"></div>
      </div>`;
            document.getElementById("formRetirada").onsubmit = e => {
                e.preventDefault();
                fetch("http://localhost:8080/movimentacoes/saida", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": token },
                    body: JSON.stringify({
                        estoqueId: produto.estoque.estoqueId,
                        produtoId: produtoId,
                        quantidade: document.getElementById("quantidadeRetirada").value
                    })
                }).then(r => r.json())
                    .then(mov => {
                        document.getElementById("resultado-retirada").innerHTML =
                            "<h4>Retirada realizada:</h4>";
                        renderizarMovimentacoes([mov]);
                        carregarProduto();
                    }).catch(() => alert("Erro ao retirar unidades"));
            };
        }

    function mostrarMovimentacoes() {
        document.getElementById("actionArea").innerHTML = `
      <div class="action-section">
        <h4>Filtrar Movimentações</h4>
        <h5>Caso queira ver todas as movimentações sem filtro de data, apenas clique em <b>buscar</b>.</h5>
        <form id="formFiltroMov">
          <label>Data Início: <input type="date" id="dataInicio"></label>
          <label>Data Final: <input type="date" id="dataFinal"></label>
          <button type="submit">Buscar</button>
        </form>
        <div id="lista-movimentacoes"></div>
      </div>`;

        document.getElementById("formFiltroMov").onsubmit = e => {
            e.preventDefault();
            const dataInicio = document.getElementById("dataInicio").value;
            const dataFinal = document.getElementById("dataFinal").value;

            let url = `http://localhost:8080/movimentacoes/produto?estoqueId=${produto.estoque.estoqueId}&produtoId=${produtoId}`;

            if (dataInicio && dataFinal) {
                url = `http://localhost:8080/movimentacoes/produtodata?estoqueId=${produto.estoque.estoqueId}&produtoId=${produtoId}&dataInicio=${dataInicio}&dataFinal=${dataFinal}`;
            }

            fetch(url, { headers: { "Authorization": token } })
                .then(r => r.json())
                .then(movs => renderizarMovimentacoes(movs))
                .catch(() => alert("Erro ao carregar movimentações"));
        };
    }

        function desativarProduto() {
            if (confirm("Tem certeza que deseja desativar este produto?")) {
                fetch(`http://localhost:8080/produto/desativar/${produtoId}`, {
                    method: "PATCH",
                    headers: { "Authorization": token }
                }).then(r => {
                    if (!r.ok) throw new Error();
                    alert("Produto desativado!");
                    window.location.href = "produtos.html";
                }).catch(() => alert("Erro ao desativar produto"));
            }
        }

        document.getElementById("btn-logout").onclick = () => {
            localStorage.removeItem("token");
            window.location.href = "login.html";
        };
        document.getElementById("btn-voltar").onclick = () => window.history.back();
    </script>
</body>

</html>